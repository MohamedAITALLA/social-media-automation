<!-- app/templates/dashboard.html -->
{% extends "base.html" %}

{% block title %}Dashboard - YouTube Channel Monitor{% endblock %}

{% block head %}
{{ super() }}
<script>
    // Auto-refresh the dashboard every 30 seconds
    setTimeout(function() {
        window.location.reload();
    }, 30000);
</script>
{% endblock %}

{% block content %}
<div class="px-4 py-5 sm:px-6">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Dashboard</h1>
    <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">Monitor your YouTube channels and webhook notifications</p>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-6">
    <!-- Total Channels -->
    <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 rounded-lg card dashboard-card border border-gray-100 dark:border-gray-700">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-secondary-500 rounded-md p-3">
                    <i class="fas fa-users text-white text-lg"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Total Channels</dt>
                        <dd class="flex items-baseline">
                            <div class="text-2xl font-semibold text-gray-900 dark:text-white">{{ stats.total_channels }}
                            </div>
                            <div class="ml-2 flex items-baseline text-sm font-semibold text-green-600 dark:text-green-400">
                                <span>{{ stats.active_channels }} active</span>
                            </div>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 px-4 py-4 sm:px-6">
            <div class="text-sm">
                <a href="{{ url_for('channels.index') }}"
                    class="font-medium text-secondary-600 hover:text-secondary-500 dark:text-secondary-400 transition-colors duration-200 flex items-center justify-between">
                    <span>Manage channels</span> <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Total Videos -->
    <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 rounded-lg card dashboard-card border border-gray-100 dark:border-gray-700">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-green-500 rounded-md p-3">
                    <i class="fas fa-video text-white text-lg"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Tracked Videos</dt>
                        <dd class="flex items-baseline">
                            <div class="text-2xl font-semibold text-gray-900 dark:text-white">{{ stats.total_videos }}
                            </div>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 px-4 py-4 sm:px-6">
            <div class="text-sm">
                <a href="#recent-videos" class="font-medium text-secondary-600 hover:text-secondary-500 dark:text-secondary-400 transition-colors duration-200 flex items-center justify-between">
                    <span>View recent videos</span> <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Active Webhooks -->
    <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 rounded-lg card dashboard-card border border-gray-100 dark:border-gray-700">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-purple-500 rounded-md p-3">
                    <i class="fas fa-bell text-white text-lg"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Active Webhooks</dt>
                        <dd class="flex items-baseline">
                            <div class="text-2xl font-semibold text-gray-900 dark:text-white">{{ stats.active_webhooks
                                }}</div>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 px-4 py-4 sm:px-6">
            <div class="text-sm">
                <a href="{{ url_for('webhooks.index') }}"
                    class="font-medium text-secondary-600 hover:text-secondary-500 dark:text-secondary-400 transition-colors duration-200 flex items-center justify-between">
                    <span>Manage webhooks</span> <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- System Status -->
    <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-lg hover:shadow-xl transition-all duration-300 rounded-lg card dashboard-card border border-gray-100 dark:border-gray-700">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-yellow-500 rounded-md p-3">
                    <i class="fas fa-cogs text-white text-lg"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">System Status</dt>
                        <dd class="flex items-baseline">
                            <div class="text-2xl font-semibold text-gray-900 dark:text-white">Active</div>
                            <div class="ml-2 flex items-baseline text-sm font-semibold text-green-600 dark:text-green-400">
                                <i class="fas fa-circle text-green-500 mr-1"></i>
                                <span>Running</span>
                            </div>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 px-4 py-4 sm:px-6">
            <div class="text-sm">
                <a href="{{ url_for('settings.index') }}"
                    class="font-medium text-secondary-600 hover:text-secondary-500 dark:text-secondary-400 transition-colors duration-200 flex items-center justify-between">
                    <span>System settings</span> <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Recent Videos Section -->
<div class="bg-white dark:bg-gray-800 shadow-lg hover:shadow-xl transition-all duration-300 rounded-lg overflow-hidden mb-6 border border-gray-100 dark:border-gray-700">
    <div class="px-4 py-5 border-b border-gray-200 dark:border-gray-700 sm:px-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="recent-videos-heading">
            Recent Videos
        </h3>
        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">
            Latest videos detected from your monitored channels
        </p>
    </div>

    <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3 p-4" id="recent-videos">
        {% if recent_videos %}
        {% for video in recent_videos %}
        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-md hover:shadow-lg transition-all duration-300 rounded-lg border border-gray-100 dark:border-gray-700 card flex flex-col h-full">
            <div class="p-4 flex-grow">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <img class="h-16 w-16 rounded-lg object-cover" src="{{ video.thumbnail_url }}" alt="Video thumbnail">
                    </div>
                    <div class="ml-4 flex-grow">
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white truncate card-title">{{ video.title }}</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            {{ format_datetime(video.published_at) }}
                        </p>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 mt-auto">
                <a href="https://www.youtube.com/watch?v={{ video.video_id }}" target="_blank"
                    class="text-sm font-medium text-secondary-600 hover:text-secondary-500 dark:text-secondary-400 transition-colors duration-200 flex items-center">
                    <i class="fab fa-youtube mr-1"></i> Watch on YouTube
                </a>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="col-span-3 text-center py-8">
            <i class="fas fa-video text-gray-400 text-4xl mb-4"></i>
            <p class="text-gray-500 dark:text-gray-400">No videos detected yet</p>
            <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">Videos will appear here once detected from your
                monitored channels</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Channels Overview -->
<div class="bg-white dark:bg-gray-800 shadow-lg hover:shadow-xl transition-all duration-300 rounded-lg overflow-hidden border border-gray-100 dark:border-gray-700">
    <div class="px-4 py-5 border-b border-gray-200 dark:border-gray-700 sm:px-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
            Monitored Channels
        </h3>
        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">
            YouTube channels currently being monitored
        </p>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th scope="col"
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                        Channel
                    </th>
                    <th scope="col"
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                        Status
                    </th>
                    <th scope="col"
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                        Last Checked
                    </th>
                    <th scope="col"
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                        Added
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                {% if channels %}
                {% for channel in channels %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div>
                                <div class="text-sm font-medium text-gray-900 dark:text-white">
                                    {{ channel.channel_name }}
                                </div>
                                <div class="text-sm text-gray-500 dark:text-gray-400">
                                    {{ channel.channel_id }}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="badge {{ 'badge-green' if channel.active else 'badge-gray' }}">
                            <i class="{{ 'fas fa-check-circle' if channel.active else 'fas fa-pause-circle' }}"></i>
                            {{ 'Active' if channel.active else 'Inactive' }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        {{ format_datetime(channel.last_checked) }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        {{ format_date(channel.added_at) }}
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                        No channels added yet. <a href="{{ url_for('channels.add') }}"
                            class="text-secondary-600 hover:text-secondary-500 dark:text-secondary-400 transition-colors duration-200">Add your first channel</a>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 text-right sm:px-6">
        <a href="{{ url_for('channels.index') }}"
            class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-secondary-600 hover:bg-secondary-700 dark:bg-secondary-500 dark:hover:bg-secondary-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-secondary-500">
            <i class="fas fa-cog mr-1"></i> Manage Channels
        </a>
    </div>
</div>

<!-- System Status Section -->
<div class="mt-8 bg-white dark:bg-gray-800 shadow-lg hover:shadow-xl transition-all duration-300 rounded-lg overflow-hidden border border-gray-100 dark:border-gray-700">
    <div class="px-4 py-5 border-b border-gray-200 dark:border-gray-700 sm:px-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
            System Status
        </h3>
        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">
            Current system health and monitoring status
        </p>
    </div>
    <div class="px-4 py-5 sm:p-6">
        <dl class="grid grid-cols-1 gap-x-4 gap-y-8 sm:grid-cols-2">
            <div class="sm:col-span-1">
                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Monitor Status</dt>
                <dd class="mt-1 text-sm text-gray-900 dark:text-white">
                    <span class="badge {{ 'badge-green' if monitor_active else 'badge-red' }}">
                        <i class="{{ 'fas fa-circle' if monitor_active else 'fas fa-times-circle' }}"></i>
                        {{ 'Running' if monitor_active else 'Stopped' }}
                    </span>
                </dd>
            </div>
            <div class="sm:col-span-1">
                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Last Check</dt>
                <dd class="mt-1 text-sm text-gray-900 dark:text-white">
                    {{ format_datetime(last_check) }}
                    {% if last_check %}
                    <span class="text-sm text-gray-500 dark:text-gray-400">({{ format_relative_time(last_check) }})</span>
                    {% endif %}
                </dd>
            </div>
            <div class="sm:col-span-1">
                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Next Check</dt>
                <dd class="mt-1 text-sm text-gray-900 dark:text-white flex items-center">
                    {% if last_check %}
                    {% set next_check = last_check + timedelta(seconds=settings.polling_interval) %}
                    {{ format_datetime(next_check) }}
                    {% if next_check < now %}
                    <span class="badge badge-yellow ml-2">
                        <i class="fas fa-clock"></i> Overdue
                    </span>
                    {% endif %}
                    {% else %}
                    Not scheduled
                    {% endif %}
                </dd>
            </div>
            <div class="sm:col-span-1">
                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">Polling Interval</dt>
                <dd class="mt-1 text-sm text-gray-900 dark:text-white">
                    {{ settings.polling_interval }} seconds ({{ (settings.polling_interval / 60)|int }} minutes)
                </dd>
            </div>
            <div class="sm:col-span-1">
                <dt class="text-sm font-medium text-gray-500 dark:text-gray-400">API Key Status</dt>
                <dd class="mt-1 text-sm text-gray-900 dark:text-white">
                    <span class="badge 
                        {% if api_key_status == 'Valid' %}
                            badge-green
                        {% elif api_key_status == 'Quota Exceeded' %}
                            badge-yellow
                        {% else %}
                            badge-red
                        {% endif %}">
                        <i class="{% if api_key_status == 'Valid' %}fas fa-check{% elif api_key_status == 'Quota Exceeded' %}fas fa-exclamation-triangle{% else %}fas fa-times{% endif %}"></i>
                        {{ api_key_status }}
                    </span>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">{{ api_key_details }}</p>
                    <form action="{{ url_for('dashboard.test_api_key') }}" method="post" class="mt-2">
                        <button type="submit" 
                            class="inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-secondary-600 hover:bg-secondary-700 dark:bg-secondary-500 dark:hover:bg-secondary-600 transition-colors duration-200">
                            <i class="fas fa-check-circle mr-1"></i> Test YouTube API
                        </button>
                    </form>
                </dd>
            </div>
        </dl>

        <div class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-6">
            <h4 class="text-sm font-medium text-gray-900 dark:text-white">Recent System Events</h4>
            <div class="mt-3 bg-gray-50 dark:bg-gray-700 rounded-md overflow-hidden shadow-inner">
                <ul class="divide-y divide-gray-200 dark:divide-gray-600">
                    {% for event in system_events %}
                    <li class="px-4 py-3 hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors duration-150">
                        <div class="flex items-center">
                            <div class="min-w-0 flex-1">
                                <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
                                    {{ event.message }}
                                </p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    {{ format_datetime(event.timestamp) }}
                                </p>
                            </div>
                            <div>
                                <span class="badge 
                                    {% if event.level == 'INFO' %}
                                        badge-blue
                                    {% elif event.level == 'WARNING' %}
                                        badge-yellow
                                    {% else %}
                                        badge-red
                                    {% endif %}">
                                    {{ event.level }}
                                </span>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                    {% if not system_events %}
                    <li class="px-4 py-5 text-center">
                        <p class="text-sm text-gray-500 dark:text-gray-400">No recent system events</p>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>

{% endblock %}